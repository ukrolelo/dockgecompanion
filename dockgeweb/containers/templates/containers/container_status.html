{% extends 'containers/base.html' %}

{% block title %}Container Status - Dockge Companion Web{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-list me-2"></i>Container Status</h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-success" id="auto-refresh-toggle">
                    <i class="fas fa-play me-1"></i>Start Auto-refresh
                </button>
                <button type="button" class="btn btn-primary" onclick="refreshContainerStatus()">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-success" onclick="scanContainers()">
                    <i class="fas fa-search me-1"></i>Scan
                </button>
                <button type="button" class="btn btn-warning" onclick="checkUpdates()">
                    <i class="fas fa-download me-1"></i>Check Updates
                </button>
            </div>
        </div>
    </div>
</div>

{% if error %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> {{ error }}
        </div>
    </div>
</div>
{% else %}

{% if not containers %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h4>No containers found</h4>
            <p>No containers are currently being tracked. Click "Scan" to start tracking containers.</p>
            <button type="button" class="btn btn-primary" onclick="scanContainers()">
                <i class="fas fa-search me-1"></i>Scan Containers
            </button>
        </div>
    </div>
</div>
{% else %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cubes me-2"></i>Containers ({{ containers|length }})
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="containers-table">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-cube me-1"></i>Container</th>
                                <th><i class="fas fa-image me-1"></i>Image</th>
                                <th class="text-center"><i class="fas fa-power-off me-1"></i>Status</th>
                                <th><i class="fas fa-fingerprint me-1"></i>Current</th>
                                <th><i class="fas fa-cloud-download-alt me-1"></i>Available</th>
                                <th class="text-center"><i class="fas fa-arrow-up me-1"></i>Updates</th>
                                <th class="text-center"><i class="fas fa-cogs me-1"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for container in containers %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ container.container_name }}</strong>
                                        {% if container.service_name %}
                                            <br><small class="text-muted">{{ container.service_name }}</small>
                                        {% endif %}
                                        {% if container.project_name %}
                                            <br><small class="badge bg-secondary">{{ container.project_name }}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <code class="small">{{ container.image }}</code>
                                </td>
                                <td class="text-center">
                                    {% if container.is_running %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-play me-1"></i>Running
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-stop me-1"></i>Stopped
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="digest-short">{{ container.digest_short }}</span>
                                </td>
                                <td>
                                    {% if container.update_info.remote_digest %}
                                        <span class="digest-short">{{ container.update_info.remote_digest|slice:":12" }}...</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if container.update_info.update_available %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-arrow-up me-1"></i>Available
                                        </span>
                                    {% elif container.update_info.error %}
                                        <span class="badge bg-danger" data-bs-toggle="tooltip" 
                                              title="{{ container.update_info.error }}">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Error
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Latest
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'containers:container_detail' container.container_name %}" 
                                           class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Manage">
                                            <i class="fas fa-cog"></i>
                                        </a>
                                        <a href="{% url 'containers:container_history' container.container_name %}" 
                                           class="btn btn-outline-info" data-bs-toggle="tooltip" title="History">
                                            <i class="fas fa-history"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endif %}

<script>
function refreshContainerStatus() {
    showLoading('Refreshing container status...');
    
    makeRequest('/api/container-status/')
        .then(data => {
            hideLoading();
            if (data.success) {
                // Reload the page to update the table
                window.location.reload();
            } else {
                showAlert('Failed to refresh status: ' + data.error, 'danger');
            }
        })
        .catch(() => {
            hideLoading();
        });
}
</script>
{% endblock %}
